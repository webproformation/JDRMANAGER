<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Deity</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00d9ff;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5rem;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        button {
            background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
            color: #000;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 217, 255, 0.5);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        #result {
            background: rgba(22, 33, 62, 0.8);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 12px;
            padding: 25px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 70vh;
            overflow-y: auto;
        }
        .success { color: #00ff88; font-weight: bold; }
        .error { color: #ff4444; font-weight: bold; }
        .info { color: #00d9ff; font-weight: bold; }
        .warning { color: #ffaa00; font-weight: bold; }
        .step {
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 217, 255, 0.05);
            border-left: 3px solid #00d9ff;
        }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Supabase Deity</h1>

        <div class="btn-group">
            <button onclick="test1()">1Ô∏è‚É£ Test Connexion</button>
            <button onclick="test2()">2Ô∏è‚É£ Lire Majere</button>
            <button onclick="test3()">3Ô∏è‚É£ Test Update Simple</button>
            <button onclick="test4()">4Ô∏è‚É£ Test Update Complet</button>
            <button onclick="test5()">5Ô∏è‚É£ V√©rifier Policies</button>
            <button onclick="clearResult()">üóëÔ∏è Effacer</button>
        </div>

        <div id="result">Cliquez sur un bouton pour commencer le diagnostic...</div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://xaldjtbabtlmdroshzux.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhbGRqdGJhYnRsbWRyb3NoenV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMDAwNzMsImV4cCI6MjA4MTg3NjA3M30.5Rlg1cWV3N1tfy0rfBEwo9bfbWLBhMHyZYekaOntIEo';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const result = document.getElementById('result');

        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const classes = {
                success: 'success',
                error: 'error',
                info: 'info',
                warning: 'warning'
            };
            result.innerHTML += `\n<div class="step"><span class="${classes[type]}">[${timestamp}]</span> ${msg}</div>`;
        }

        window.clearResult = () => {
            result.innerHTML = 'Console effac√©e. Pr√™t pour un nouveau test.\n';
        };

        // Test 1: Connexion basique
        window.test1 = async () => {
            result.innerHTML = '<div class="info">‚ïê‚ïê‚ïê TEST 1: V√âRIFICATION DE LA CONNEXION ‚ïê‚ïê‚ïê</div>\n';

            try {
                log('üîå Test de connexion √† Supabase...', 'info');
                log(`üìç URL: ${SUPABASE_URL}`, 'info');

                const { data, error } = await supabase
                    .from('deities')
                    .select('count')
                    .limit(1);

                if (error) {
                    log(`‚ùå Erreur de connexion: ${error.message}`, 'error');
                    log(`D√©tails: ${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    log('‚úÖ Connexion r√©ussie!', 'success');
                }
            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'error');
            }
        };

        // Test 2: Lecture de Majere
        window.test2 = async () => {
            result.innerHTML = '<div class="info">‚ïê‚ïê‚ïê TEST 2: LECTURE DE MAJERE ‚ïê‚ïê‚ïê</div>\n';

            try {
                log('üìñ Lecture de la d√©it√© Majere...', 'info');

                const { data, error } = await supabase
                    .from('deities')
                    .select('id, name, pantheon, image_url, deity_images, description')
                    .eq('id', '2ee53f59-3bd7-44a4-9feb-582a02cc202f')
                    .single();

                if (error) {
                    log(`‚ùå Erreur: ${error.message}`, 'error');
                    result.innerHTML += `<pre>${JSON.stringify(error, null, 2)}</pre>`;
                } else {
                    log('‚úÖ Lecture r√©ussie!', 'success');
                    log(`üìù Nom: ${data.name}`, 'info');
                    log(`üåç Panth√©on: ${data.pantheon || 'Non d√©fini'}`, 'info');
                    log(`üñºÔ∏è Image URL: ${data.image_url || 'Aucune'}`, 'info');
                    log(`üì∏ Deity Images: ${JSON.stringify(data.deity_images) || 'Aucune'}`, 'info');
                    result.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'error');
            }
        };

        // Test 3: Update simple
        window.test3 = async () => {
            result.innerHTML = '<div class="info">‚ïê‚ïê‚ïê TEST 3: UPDATE SIMPLE ‚ïê‚ïê‚ïê</div>\n';

            try {
                const testValue = 'TEST-' + Date.now();
                log(`üîÑ Mise √† jour avec: ${testValue}`, 'info');

                const { data, error } = await supabase
                    .from('deities')
                    .update({
                        description: testValue,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', '2ee53f59-3bd7-44a4-9feb-582a02cc202f')
                    .select();

                if (error) {
                    log(`‚ùå Erreur UPDATE: ${error.message}`, 'error');
                    log(`Code: ${error.code}`, 'error');
                    log(`D√©tails: ${error.details}`, 'error');
                    log(`Hint: ${error.hint}`, 'error');
                    result.innerHTML += `<pre>${JSON.stringify(error, null, 2)}</pre>`;
                } else {
                    log('‚úÖ Update r√©ussi!', 'success');
                    log(`Donn√©es retourn√©es: ${data ? 'Oui' : 'Non'}`, 'info');
                    result.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;

                    // V√©rification
                    log('üîç V√©rification...', 'info');
                    const { data: checkData } = await supabase
                        .from('deities')
                        .select('description')
                        .eq('id', '2ee53f59-3bd7-44a4-9feb-582a02cc202f')
                        .single();

                    if (checkData.description === testValue) {
                        log('‚úÖ V√©rification: La donn√©e a bien √©t√© enregistr√©e!', 'success');
                    } else {
                        log('‚ö†Ô∏è V√©rification: La donn√©e ne correspond pas!', 'warning');
                        log(`Attendu: ${testValue}`, 'warning');
                        log(`Re√ßu: ${checkData.description}`, 'warning');
                    }
                }
            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'error');
            }
        };

        // Test 4: Update complet avec deity_images
        window.test4 = async () => {
            result.innerHTML = '<div class="info">‚ïê‚ïê‚ïê TEST 4: UPDATE COMPLET ‚ïê‚ïê‚ïê</div>\n';

            try {
                const testData = {
                    description: 'TEST COMPLET - ' + Date.now(),
                    image_url: 'https://test.com/image-' + Date.now() + '.png',
                    deity_images: {
                        god: ['https://test.com/god1.png', 'https://test.com/god2.png'],
                        temples: ['https://test.com/temple1.png'],
                        disciples: [],
                        symbols: ['https://test.com/symbol1.png']
                    },
                    pantheon: 'Krynn (TEST)',
                    updated_at: new Date().toISOString()
                };

                log('üì¶ Donn√©es √† envoyer:', 'info');
                result.innerHTML += `<pre>${JSON.stringify(testData, null, 2)}</pre>`;

                log('üöÄ Envoi de la requ√™te UPDATE...', 'info');

                const { data, error } = await supabase
                    .from('deities')
                    .update(testData)
                    .eq('id', '2ee53f59-3bd7-44a4-9feb-582a02cc202f')
                    .select();

                if (error) {
                    log(`‚ùå Erreur UPDATE: ${error.message}`, 'error');
                    result.innerHTML += `<pre>${JSON.stringify(error, null, 2)}</pre>`;
                } else {
                    log('‚úÖ Update r√©ussi!', 'success');
                    result.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;

                    // V√©rification
                    log('üîç V√©rification imm√©diate...', 'info');
                    const { data: checkData } = await supabase
                        .from('deities')
                        .select('description, image_url, deity_images, pantheon')
                        .eq('id', '2ee53f59-3bd7-44a4-9feb-582a02cc202f')
                        .single();

                    result.innerHTML += '<div class="step">üìä Donn√©es v√©rifi√©es:</div>';
                    result.innerHTML += `<pre>${JSON.stringify(checkData, null, 2)}</pre>`;

                    if (checkData.description === testData.description) {
                        log('‚úÖ Description: OK', 'success');
                    } else {
                        log('‚ö†Ô∏è Description: PAS OK', 'warning');
                    }

                    if (checkData.image_url === testData.image_url) {
                        log('‚úÖ Image URL: OK', 'success');
                    } else {
                        log('‚ö†Ô∏è Image URL: PAS OK', 'warning');
                    }

                    if (JSON.stringify(checkData.deity_images) === JSON.stringify(testData.deity_images)) {
                        log('‚úÖ Deity Images: OK', 'success');
                    } else {
                        log('‚ö†Ô∏è Deity Images: PAS OK', 'warning');
                    }
                }
            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'error');
                console.error('Erreur compl√®te:', error);
            }
        };

        // Test 5: V√©rifier les policies
        window.test5 = async () => {
            result.innerHTML = '<div class="info">‚ïê‚ïê‚ïê TEST 5: V√âRIFICATION DES POLICIES ‚ïê‚ïê‚ïê</div>\n';

            try {
                log('üîê V√©rification des permissions RLS...', 'info');

                // Test SELECT
                log('üìñ Test SELECT...', 'info');
                const { data: selectData, error: selectError } = await supabase
                    .from('deities')
                    .select('id')
                    .limit(1);

                if (selectError) {
                    log(`‚ùå SELECT: ${selectError.message}`, 'error');
                } else {
                    log(`‚úÖ SELECT: OK (${selectData.length} lignes)`, 'success');
                }

                // Test UPDATE
                log('üîÑ Test UPDATE...', 'info');
                const { error: updateError } = await supabase
                    .from('deities')
                    .update({ updated_at: new Date().toISOString() })
                    .eq('id', '2ee53f59-3bd7-44a4-9feb-582a02cc202f');

                if (updateError) {
                    log(`‚ùå UPDATE: ${updateError.message}`, 'error');
                    if (updateError.code === '42501') {
                        log('‚ö†Ô∏è Erreur 42501: Probl√®me de permissions RLS', 'warning');
                    }
                } else {
                    log('‚úÖ UPDATE: OK', 'success');
                }

                // V√©rifier le r√¥le
                log('üë§ R√¥le actuel: anon (utilisateur anonyme)', 'info');

            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'error');
            }
        };

        // Log initial
        log('üéØ Outil de diagnostic pr√™t!', 'success');
        log('Commencez par le Test 1 pour v√©rifier la connexion.', 'info');
    </script>
</body>
</html>
